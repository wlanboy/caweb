{% extends "base.html" %}

{% block title %}Neues Zertifikat{% endblock %}
{% block content %}

{% if not ca_exists %}
<div class="ca-warning">
  <p><strong>Es wurde keine CA gefunden.</strong></p>
  <form method="post" action="/create-ca">
    <label>CA-Schlüsseltyp:
      <select name="ca_key_type" class="select">
        {% for value, label, _ in key_types %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit" class="ca-button">CA erstellen</button>
  </form>
</div>
{% endif %}

{% if ca_created %}
<div class="ca-success">
  <p><strong>CA erfolgreich erstellt!</strong></p>
</div>
{% endif %}

<h2>Zertifikat erstellen</h2>
<form method="post" action="/">
  <label>Hostname:
    <input type="text" name="hostname" required>
  </label>
  <label>Alternative Namen (Komma-getrennt, DNS-Namen oder IP-Adressen):
    <input type="text" name="alt_names" placeholder="z.B. www.example.com, 192.168.1.100">
  </label>

  <label>Zertifikat-Schlüsseltyp:
    <select name="cert_key_type" class="select">
      {% for value, label, _ in key_types %}
      <option value="{{ value }}">{{ label }}</option>
      {% endfor %}
    </select>
  </label>

  <label>Gültigkeit (Tage):
    <input type="number" name="validity_days" value="825" min="1" max="3650">
  </label>

  <button type="submit">Erstellen</button>
</form>

{% if hostname %}
<h3>Ergebnis für {{ hostname }}</h3>
<h4>Certificate</h4>
<pre>{{ cert_content }}</pre>
<h4>Private Key</h4>
<pre>{{ key_content }}</pre>
{% endif %}
{% endblock %}

{% block ca_content %}
{% if ca_exists %}

<div class="ca-collapsible-container">

  <!-- Checkbox steuert das Auf-/Zuklappen -->
  <input type="checkbox" id="ca-toggle" class="ca-checkbox">

  <!-- Label ist der sichtbare Button -->
  <label for="ca-toggle" class="ca-toggle">
    <span class="ca-toggle-icon">⚠️</span>
    <span class="ca-toggle-text">Hinweise zur Installation der CA anzeigen</span>
  </label>

  <!-- Der einklappbare Bereich -->
  <div class="ca-info">

    <div class="ca-download-box">
      <h3>CA herunterladen</h3>

      <a href="/download-ca/ca.pem" class="ca-download-button">CA Zertifikat herunterladen</a>

      <div class="ca-install-hint">
        <h4>Installation der CA</h4>
        <p>Damit Zertifikate als vertrauenswürdig gelten, muss die CA im System installiert werden.</p>

        <h5>Linux (Debian/Ubuntu)</h5>
        <pre>sudo cp ca.pem /usr/local/share/ca-certificates/homelab-ca.crt
sudo update-ca-certificates</pre>

        <h5>Linux (RHEL/CentOS/Fedora)</h5>
        <pre>sudo cp ca.pem /etc/pki/ca-trust/source/anchors/homelab-ca.crt
sudo update-ca-trust</pre>

        <h5>macOS</h5>
        <pre>sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ca.pem</pre>

        <h5>Android</h5>
        <p>
          1. „ca.pem“ auf das Gerät kopieren (ggf. in .crt umbenennen)<br>
          2. Einstellungen &rarr; Sicherheit &rarr; Verschlüsselung & Anmeldedaten<br>
          3. „CA-Zertifikat“ (oder „Von Speicher installieren“) wählen<br>
          4. Warnung bestätigen und Datei auswählen
        </p>

        <h5>iOS (iPhone/iPad)</h5>
        <p>
          1. „ca.pem“ via AirDrop oder iCloud öffnen und „Laden“ erlauben<br>
          2. Einstellungen &rarr; Profil geladen &rarr; Installieren<br>
          3. Einstellungen &rarr; Allgemein &rarr; Info &rarr; Zertifikatsvertrauenseinstellungen<br>
          4. Schalter für die neue CA unter „Volles Vertrauen für Root-Zertifikate“ aktivieren
        </p>

        <h5>Windows</h5>
        <p>
          1. „ca.pem“ doppelklicken<br>
          2. „Zertifikat installieren“ wählen<br>
          3. „Lokaler Computer“ auswählen<br>
          4. In „Vertrauenswürdige Stammzertifizierungsstellen“ installieren
        </p>
      </div><!--ca-install-hint-->

    </div><!--ca-download-box-->

  </div><!--ca-info-->

</div> <!--ca-collapsible-container-->

{% endif %}
{% endblock %}

